# 📝 로그인 & 인증 시스템 정리

## 1. 목표
- NestJS + React 기반의 **관리자 페이지 로그인/인증 시스템** 구축  
- **안전한 비밀번호 저장 방식**과 **JWT 인증 구조** 적용  
- 로그인 실패 시 계정 잠금/자동 해제 등 보안 정책 반영  

---

## 2. 사용 기술
- **NestJS** : 백엔드 API 서버  
- **React (Vite + AntD)** : 프론트엔드 관리자 페이지  
- **TypeORM + MySQL** : 데이터베이스 관리  
- **argon2** : 비밀번호 해시 알고리즘  
- **JWT (JSON Web Token)** : 세션리스 인증 방식  

---

## 3. 엔티티 구조 (User)

```ts
import {Entity, PrimaryGeneratedColumn, Column, DeleteDateColumn} from 'typeorm';

@Entity('users')
export class User {
    @PrimaryGeneratedColumn()
    id: number;

    // 로그인 계정 아이디
    @Column({length: 50, unique: true})
    username: string;

    // 로그인 비밀번호 (암호화된 해시)
    @Column()
    password: string;

    // 권한/등급
    @Column({default: 'USER'})
    role: string; // 'SUPER_ADMIN' | 'ADMIN' | 'MANAGER' | 'USER'

    // 이메일 (아이디 대체/비밀번호 찾기용)
    @Column({unique: true, nullable: true})
    email: string;

    // 연락처
    @Column({nullable: true})
    phone: string;

    // 프로필 이미지 URL
    @Column({nullable: true})
    avatarUrl: string;

    // 계정 활성화 여부
    @Column({default: true})
    isActive: boolean;

    // 로그인 실패 횟수
    @Column({default: 0})
    loginFailCount: number;

    // 언제 잠겼는지 기록
    @Column({ type: 'timestamp', nullable: true })
    lockedAt: Date | null;
    // 마지막 로그인 시각
    @Column({type: 'timestamp', nullable: true})
    lastLoginAt: Date;

    // 비밀번호 변경 시각
    @Column({type: 'timestamp', nullable: true})
    passwordChangedAt: Date;

    // 계정 생성일
    @Column({type: 'timestamp', default: () => 'CURRENT_TIMESTAMP'})
    createdAt: Date;

    // 마지막 수정일
    @Column({
        type: 'timestamp',
        default: () => 'CURRENT_TIMESTAMP',
        onUpdate: 'CURRENT_TIMESTAMP',
    })
    updatedAt: Date;

    // 소프트 삭제 컬럼
    @DeleteDateColumn({type: 'timestamp', nullable: true})
    deletedAt?: Date;

    // 계정 비고/메모
    @Column({type: 'text', nullable: true})
    note: string;
}

```

---

## 4. 비밀번호 보안 – 왜 **argon2**?
- 기존 **crypto+salt(SHA256)**: 빠른 알고리즘 → **무차별 대입 공격에 취약**  
- **bcrypt**: 안전하지만 오래된 알고리즘, GPU 병렬 공격 방어 한계  
- **argon2id**: 공식 권장 최신 알고리즘, 메모리 기반 공격 저항성 높음  
- 결론: **argon2로 모든 비밀번호 저장 & 검증**

```ts
const hash = await argon2.hash(plainPassword, {
  type: argon2.argon2id,
  memoryCost: 2 ** 16,
  timeCost: 5,
  parallelism: 1,
});
const ok = await argon2.verify(hash, inputPassword);
```

---

## 5. 인증 – 왜 **JWT**?
- 세션 방식: 서버에 상태 저장(Session Store) 필요 → 확장성 문제  
- JWT: **stateless** → 서버 확장성, 마이크로서비스에 유리  
- AccessToken + RefreshToken 구조로 보안 강화:
  - **AccessToken**: 짧게(예: 15분) → 탈취 위험 최소화  
  - **RefreshToken**: 길게(예: 7일) → DB/Redis에 저장, 만료/로그아웃 시 제거  

---

## 6. 로그인 로직

### 성공 시
1. argon2 검증 성공 → 로그인 성공  
2. `lastLoginAt` 업데이트, `loginFailCount=0`, `lockedAt=null`  
3. AccessToken + RefreshToken 발급  
4. React에서 `localStorage`에 저장  

### 실패 시
1. 로그인 실패 → `loginFailCount += 1`  
2. 5회 이상 → `isActive=false`, `lockedAt=현재시간` → 계정 잠금  
3. 계정 잠금 상태:
   - 30분 후 자동 해제  
   - 해제 전에는 로그인 불가  

---

## 7. React 프론트엔드

### 로그인 페이지
- AntD Form + axios로 `/auth/login` 호출  
- 성공 시:
  - `localStorage.setItem("token", access_token)`  
  - 성공 메시지 + `/`로 이동  
- 실패 시:
  - NestJS 에러 메시지 그대로 출력  

### 사용자 목록
- axios 인터셉터: 모든 요청에 `Authorization: Bearer <token>` 자동 첨부  
- 토큰 없거나 만료 시 → NestJS에서 401 반환 → React가 로그인 페이지로 리다이렉트  

---

## 8. 보안 정책
- **argon2**: 최신 표준 비밀번호 해싱  
- **JWT AccessToken**: 15분 만료 (짧게 유지)  
- **JWT RefreshToken**: 7일 만료 (서버 저장 & 로그아웃 시 삭제)  
- **계정 잠금**: 5회 실패 시 잠금, 30분 후 자동 해제  
- **권한(Role)**: SUPER_ADMIN, ADMIN, USER → API 접근 제어  

---

## ✅ 정리
- **비밀번호 보안**: crypto+salt → argon2 전환  
- **인증**: JWT 세션리스 구조  
- **보안 강화**:
  - 짧은 AccessToken + 긴 RefreshToken  
  - 계정 잠금 & 자동 해제  
- **프론트/백엔드 역할 분리**:
  - NestJS → API 보호 (401 반환)  
  - React → 라우팅 보호 (로그인 안 된 사용자 리다이렉트)  
