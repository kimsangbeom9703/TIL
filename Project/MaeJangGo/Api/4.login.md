# 로그인 정리

## modules/auth

### auth.controller.ts
```ts
import { Controller, Post, Body } from '@nestjs/common';
import { AuthService } from './auth.service';

@Controller('auth')
export class AuthController {
    constructor(private readonly authService: AuthService) {}

    @Post('login')
    async login(@Body() body: { username: string; password: string }) {
        const user = await this.authService.validateUser(body.username, body.password);
        return this.authService.login(user);
    }
}
```
### auth.module.ts
```ts
import { Module } from '@nestjs/common';
import { JwtModule } from '@nestjs/jwt';
import { PassportModule } from '@nestjs/passport';
import { ConfigModule, ConfigService } from '@nestjs/config';
import { AuthService } from './auth.service';
import { AuthController } from './auth.controller';
import { JwtStrategy } from './jwt.strategy';
import { UsersModule } from '../users/users.module';

@Module({
    imports: [
        UsersModule,
        PassportModule,
        ConfigModule,
        JwtModule.registerAsync({
            imports: [ConfigModule],
            inject: [ConfigService],
            useFactory: (cs: ConfigService) => ({
                secret: cs.get<string>('JWT_SECRET'),
                signOptions: { expiresIn: cs.get<string>('JWT_ACCESS_EXPIRES_IN') ?? '15m' },
            }),
        }),
    ],
    providers: [AuthService, JwtStrategy],
    controllers: [AuthController],
    exports: [AuthService],
})
export class AuthModule {}
```
### auth.service.ts
```ts
// src/modules/auth/auth.service.ts
import { Injectable, UnauthorizedException, ForbiddenException } from '@nestjs/common';
import { JwtService } from '@nestjs/jwt';
import { UsersService } from '../users/users.service';
import { verifyPassword, hashPassword } from './password.util';

@Injectable()
export class AuthService {
    constructor(
        private readonly usersService: UsersService,
        private readonly jwtService: JwtService,
    ) {}

    async validateUser(username: string, password: string) {
        const user = await this.usersService.findByUsername(username);
        if (!user) throw new UnauthorizedException('존재하지 않는 계정입니다.');

        // 자동 잠금 해제 체크
        const lockDurationMinutes = parseInt(process.env.LOCK_DURATION_MINUTES ?? '30', 10);
        if (!user.isActive && user.lockedAt) {
            const lockedTime = new Date(user.lockedAt).getTime();
            if (Date.now() - lockedTime >= lockDurationMinutes * 60 * 1000) {
                user.isActive = true;
                user.loginFailCount = 0;
                user.lockedAt = null;
                await this.usersService.save(user);
            }
        }

        if (!user.isActive) {
            throw new ForbiddenException(
                `계정이 잠겨 있습니다. ${lockDurationMinutes}분 후 다시 시도하세요.`,
            );
        }

        // ✅ argon2 검증
        const passwordMatch = await verifyPassword(user.password, password);
        if (!passwordMatch) {
            user.loginFailCount += 1;
            if (user.loginFailCount >= 5) {
                user.isActive = false;
                user.lockedAt = new Date();
            }
            await this.usersService.save(user);
            throw new UnauthorizedException('아이디 또는 비밀번호가 올바르지 않습니다.');
        }

        // 성공 처리
        user.lastLoginAt = new Date();
        user.loginFailCount = 0;
        user.lockedAt = null;
        await this.usersService.save(user);

        const { password: _, ...result } = user;
        return result;
    }

    async login(user: any) {
        const payload = { username: user.username, sub: user.id, role: user.role };
        return {
            access_token: this.jwtService.sign(payload, {
                secret: process.env.JWT_SECRET,
                expiresIn: process.env.JWT_ACCESS_EXPIRES_IN || '15m',
            }),
            refresh_token: this.jwtService.sign(payload, {
                secret: process.env.JWT_SECRET,
                expiresIn: process.env.JWT_REFRESH_EXPIRES_IN || '7d',
            }),
        };
    }
}
```
### jwt.strategy.ts
```ts
import { Injectable } from '@nestjs/common';
import { PassportStrategy } from '@nestjs/passport';
import { ExtractJwt, Strategy } from 'passport-jwt';

@Injectable()
export class JwtStrategy extends PassportStrategy(Strategy) {
    constructor() {
        super({
            jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),
            secretOrKey: process.env.JWT_SECRET || 'secretKey',
        });
    }

    async validate(payload: any) {
        return { id: payload.sub, username: payload.username, role: payload.role };
    }
}
```
### password.util.ts
```ts
// src/modules/auth/password.util.ts
import * as argon2 from 'argon2';

export async function hashPassword(password: string): Promise<string> {
    return argon2.hash(password, {
        type: argon2.argon2id, // 가장 권장되는 모드
        memoryCost: 2 ** 16,   // 64MB 사용
        timeCost: 5,           // 연산 횟수
        parallelism: 1,        // 병렬 처리
    });
}

export async function verifyPassword(hash: string, plain: string): Promise<boolean> {
    return argon2.verify(hash, plain);
}
```
