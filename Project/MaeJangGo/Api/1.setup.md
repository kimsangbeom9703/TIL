# 매장고 API 서버

## 개발 환경
```
Nest JS
MySQL
```

## 설치

```bash
$ npm i -g @nestjs/cli
$ nest new MaeJangGO
```
OR
```bash
$ git clone https://github.com/nestjs/typescript-starter.git MaeJangGO
$ cd MaeJangGO
$ npm install
$ npm run start
```

## 구조 변경
```
├─src
│  ├─common
│  ├─config
│  ├─entities
│  ├─migrations
│  ├─modules
│  │  ├─auth
│  │  ├─products
│  │  └─users
│  ├─types
│  └─utils
```

## 환경변수 설정(.env)
```
NODE_ENV=development
PORT=4000
DB_HOST=localhost
DB_PORT=3306
DB_USER=maejanggo_manager
DB_PASS=
DB_NAME=solution_maejanggo_svr_real
```
---
## config 설정

### env.config.ts
```ts
import { registerAs } from '@nestjs/config';

export default registerAs('app', () => ({
    nodeEnv: process.env.NODE_ENV || 'development',
    port: parseInt(process.env.PORT ?? '3000', 10),
}));
```

### database.config.ts
```ts
import { registerAs } from '@nestjs/config';
import { TypeOrmModuleOptions } from '@nestjs/typeorm';

export default registerAs(
    'database',
    (): TypeOrmModuleOptions => ({
        type: 'mysql',
        host: process.env.DB_HOST,
        port: parseInt(process.env.DB_PORT ?? '3306', 10),
        username: process.env.DB_USER,
        password: process.env.DB_PASS,
        database: process.env.DB_NAME,
        entities: [__dirname + '/../**/*.entity{.ts,.js}'], // 엔티티 자동 스캔
        synchronize: process.env.NODE_ENV !== 'production', // 개발용일 때만 true
        logging: true,
    }),
);
```
### data-source.ts
```ts
import {DataSource} from 'typeorm';
import * as dotenv from 'dotenv';
import {User} from '../entities/user.entity';

dotenv.config();

export const AppDataSource = new DataSource({
    type: 'mysql',
    host: process.env.DB_HOST,
    port: parseInt(process.env.DB_PORT ?? '3306', 10),
    username: process.env.DB_USER,
    password: process.env.DB_PASS,
    database: process.env.DB_NAME,
    entities: [User],
    migrations: ['src/migrations/*.ts'],
    synchronize: false,
});
```
---
## entities 설정

### user.entity.ts
```ts
import { Entity, PrimaryGeneratedColumn, Column, DeleteDateColumn } from 'typeorm';

@Entity('users')
export class User {
    @PrimaryGeneratedColumn()
    id: number;

    // 로그인 계정 아이디
    @Column({ length: 50, unique: true })
    username: string;

    // 로그인 비밀번호 (암호화된 해시)
    @Column()
    password: string;

    // 비밀번호 해싱에 사용된 salt
    @Column()
    passwordSalt: string;

    // 권한/등급
    @Column({ default: 'USER' })
    role: string; // 'SUPER_ADMIN' | 'ADMIN' | 'MANAGER' | 'USER'

    // 이메일 (아이디 대체/비밀번호 찾기용)
    @Column({ unique: true, nullable: true })
    email: string;

    // 연락처
    @Column({ nullable: true })
    phone: string;

    // 프로필 이미지 URL
    @Column({ nullable: true })
    avatarUrl: string;

    // 계정 활성화 여부
    @Column({ default: true })
    isActive: boolean;

    // 로그인 실패 횟수
    @Column({ default: 0 })
    loginFailCount: number;

    // 마지막 로그인 시각
    @Column({ type: 'timestamp', nullable: true })
    lastLoginAt: Date;

    // 비밀번호 변경 시각
    @Column({ type: 'timestamp', nullable: true })
    passwordChangedAt: Date;

    // 계정 생성일
    @Column({ type: 'timestamp', default: () => 'CURRENT_TIMESTAMP' })
    createdAt: Date;

    // 마지막 수정일
    @Column({
        type: 'timestamp',
        default: () => 'CURRENT_TIMESTAMP',
        onUpdate: 'CURRENT_TIMESTAMP',
    })
    updatedAt: Date;

    // 소프트 삭제 컬럼
    @DeleteDateColumn({ type: 'timestamp', nullable: true })
    deletedAt?: Date;

    // 계정 비고/메모
    @Column({ type: 'text', nullable: true })
    note: string;
}
```

--- 

## modules 설정

### users/users.controller.ts
```ts
import {Controller, Get, Post, Param, Delete, Body} from '@nestjs/common';
import {UsersService} from './users.service';

@Controller('users')
export class UsersController {
    constructor(private readonly usersService: UsersService) {
    }

    @Get()
    findAll() {
        return [
            {id: 1, username: 'ksb', isActive: true},
            {id: 2, username: 'hong', isActive: false},
        ];
        // return this.usersService.findAll();
    }

    @Get(':id')
    findOne(@Param('id') id: string) {
        return this.usersService.findOne(Number(id));
    }

    @Post()
    create(@Body() body: { username: string; password: string }) {
        return this.usersService.create(body.username, body.password);
    }

    @Delete(':id')
    remove(@Param('id') id: string) {
        return this.usersService.remove(Number(id));
    }
}
```
### users/users.module.ts
```ts
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { User } from '../../entities/user.entity';
import { UsersService } from './users.service';
import { UsersController } from './users.controller';

@Module({
    imports: [TypeOrmModule.forFeature([User])], // 이 모듈에서 User 엔티티 사용
    controllers: [UsersController],
    providers: [UsersService],
})
export class UsersModule {}
```
### users/users.service.ts
```ts
import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { User } from '../../entities/user.entity';

@Injectable()
export class UsersService {
    constructor(
        @InjectRepository(User)
        private usersRepo: Repository<User>,
    ) {}

    findAll(): Promise<User[]> {
        return this.usersRepo.find();
    }

    findOne(id: number): Promise<User | null> {
        return this.usersRepo.findOneBy({ id });
    }

    create(username: string, password: string): Promise<User> {
        const user = this.usersRepo.create({ username, password });
        return this.usersRepo.save(user);
    }

    async remove(id: number): Promise<void> {
        await this.usersRepo.delete(id);
    }
}
```

--- 

## app.modules.ts
```ts
import {Module} from '@nestjs/common';
import {AppController} from './app.controller';
import {AppService} from './app.service';
import {ConfigModule, ConfigService} from '@nestjs/config';
import {TypeOrmModule, TypeOrmModuleOptions} from '@nestjs/typeorm';
import envConfig from './config/env.config';
import dbConfig from './config/database.config';
import {UsersModule} from './modules/users/users.module';

@Module({
    imports: [
        ConfigModule.forRoot({
            isGlobal: true,              // 전역에서 사용 가능
            load: [envConfig, dbConfig], // DB 설정도 로드
            envFilePath: '.env',         // .env 파일 경로 (기본은 루트)
        }),
        TypeOrmModule.forRootAsync({
            imports: [ConfigModule],
            inject: [ConfigService],
            useFactory: (configService: ConfigService) =>
                configService.get<TypeOrmModuleOptions>('database')!, // ✅ undefined 아님을 보장
        }),
        UsersModule,
    ],
    controllers: [AppController],
    providers: [AppService],
})
export class AppModule {
}
```
## main.ts
```ts
import {NestFactory} from '@nestjs/core';
import {AppModule} from './app.module';
import {ConfigService} from '@nestjs/config';

async function bootstrap() {
    const app = await NestFactory.create(AppModule);

    app.enableCors({
        origin: 'http://localhost:5173',
    });

    const configService = app.get(ConfigService);
    const port = configService.get<number>('app.port');  // .env의 PORT 값 읽기
    await app.listen(port || 3000);
}

bootstrap();
```